<ui-spinner *ngIf="loading"></ui-spinner>
<div *ngIf="formId && fields.length > 0 && !loading">
  <div class="flex items-center mb-2">
    <h2 class="ml-2 my-1">{{ 'common.field.few' | translate }}</h2>
    <ui-icon
      icon="info_outline"
      variant="grey"
      [size]="18"
      [uiTooltip]="'common.dataStudio.dataGeneration.fieldsTooltip' | translate"
      class="mx-2 my-1"
    ></ui-icon>
    <ui-checkbox
      (click)="$event.stopPropagation()"
      class="ml-auto mr-2"
      [(ngModel)]="isChecked"
      (change)="selectAll()"
    >
      <ng-container ngProjectAs="label" class="ml-auto">
        {{ 'common.dataStudio.dataGeneration.selectAll' | translate }}
      </ng-container>
    </ui-checkbox>
  </div>
  <!-- Content -->
  <cdk-accordion>
    <form [formGroup]="dataGenerationForm">
      <div formArrayName="fieldsForm">
        <ui-expansion-panel
          *ngFor="let field of fields; let index = index"
          [index]="index"
          (openPanel)="
            onAccordionItemOpen(index); accordionItemExpanded = index
          "
        >
          <ng-container ngProjectAs="title" formGroupName="{{ index }}">
            {{ field.name }}
            <ui-checkbox
              (click)="$event.stopPropagation()"
              class="ml-auto"
              formControlName="include"
            >
            </ui-checkbox>
          </ng-container>
          <div
            formGroupName="{{ index }}"
            *ngIf="
              field.type != 'file' &&
                field.type != 'image' &&
                field.type != 'html' &&
                field.type != 'expression';
              else invalidFields
            "
          >
            <div class="flex my-2">
              <div class="px-3 field-type whitespace-nowrap">
                <b>{{
                  'common.dataStudio.dataGeneration.fieldType' | translate
                }}</b
                >{{ getDisplayName(field) }}
              </div>
              <div class="px-3 flex whitespace-nowrap w-3/4">
                <b>{{
                  'common.dataStudio.dataGeneration.generationSource'
                    | translate
                }}</b>
                <div class="ml-2">
                  {{ getGenerationSource(field) }}
                </div>
              </div>
            </div>

            <div class="flex m-3">
              <ui-toggle formControlName="setDefault" class="mt-1.5">
                <ng-container ngProjectAs="label">
                  {{
                    'common.dataStudio.dataGeneration.setDefault' | translate
                  }}
                </ng-container>
              </ui-toggle>
              <ui-icon
                icon="info_outline"
                variant="grey"
                [size]="14"
                [uiTooltip]="
                  'common.dataStudio.dataGeneration.setDefaultTooltip'
                    | translate
                "
                class="m-1"
              ></ui-icon>
            </div>
            <div class="my-4 mx-8">
              <survey
                *ngIf="
                  fieldsForm.value[index].setDefault &&
                  accordionItemExpanded === index
                "
                [model]="survey"
              ></survey>
            </div>
          </div>
          <ng-template #invalidFields>
            <div class="px-3">
              <b>{{
                'common.dataStudio.dataGeneration.fieldType' | translate
              }}</b
              >{{ getDisplayName(field.type) }}
            </div>
            <div class="m-2">
              <i>{{
                'common.dataStudio.dataGeneration.generationNotPossible'
                  | translate
              }}</i>
            </div>
          </ng-template>
        </ui-expansion-panel>
      </div>
      <div class="flex justify-end my-4">
        <div uiFormFieldDirective class="w-72">
          <input
            type="number"
            min="1"
            max="50"
            formControlName="recordsNumber"
            [placeholder]="
              'common.dataStudio.dataGeneration.recordsNumber' | translate
            "
          />
        </div>

        <ui-button
          category="secondary"
          variant="primary"
          icon="autorenew"
          (click)="onClick()"
          [disabled]="!dataGenerationForm.valid || loading"
          class="mx-4"
        >
          {{ 'common.dataStudio.dataGeneration.generate' | translate }}
        </ui-button>
      </div>
    </form>
  </cdk-accordion>
  <pre>{{ dataGenerationForm.value | json }}</pre>
</div>
