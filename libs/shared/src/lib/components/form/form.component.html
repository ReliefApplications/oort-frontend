<!-- Form header -->
<div class="flex flex-wrap justify-between items-center gap-4">
  <shared-record-summary
    *ngIf="record"
    [record]="record"
    (showHistory)="onShowHistory()"
  ></shared-record-summary>
</div>
<!-- Form pages -->

<!-- Loading indicator -->
<ui-spinner
  class="flex justify-center items-center h-screen"
  *ngIf="saving"
></ui-spinner>
<!-- Form -->
<div #formContainer></div>
<!-- Floating div for form buttons actions -->
<ng-container *ngIf="surveyActive && floatingActions">
  <ui-fixed-wrapper>
    <ng-container *ngTemplateOutlet="actionButtons"></ng-container>
  </ui-fixed-wrapper>
</ng-container>

<div class="flex">
  <shared-form-pages-layout
    class="h-fit sticky top-0 z-10"
    *ngIf="!survey.hidePagesTab"
    (showPage)="onShowPage($event)"
    [pages]="survey.visiblePages"
    [selectedPageIndex]="(selectedPageIndex$ | async) ?? 0"
  ></shared-form-pages-layout>
  <div
    *ngIf="survey.showErrorsOnSide && errorQuestions.length"
    class="border border-red-500 bg-red-50 p-4 rounded-lg mr-4 h-fit sticky top-4 max-h-[calc(100vh-220px)] overflow-y-auto"
  >
    <h3 class="text-red-700 font-semibold text-lg mb-2">
      Please fix the following errors:
    </h3>
    <ul class="list-disc list-inside space-y-1">
      <li
        (click)="onErrorClick(error.questionName)"
        class="text-red-600 hover:underline cursor-pointer"
        *ngFor="let error of errorQuestions"
      >
        {{ error.label }}
        <span class="italic text-sm text-red-500">â€” {{ error.message }}</span>
      </li>
    </ul>
  </div>
  <survey [model]="survey" class="flex-1"></survey>
</div>

<!-- Form buttons actions without floating div-->
<div class="relative" *ngIf="surveyActive && !floatingActions">
  <ng-container *ngTemplateOutlet="actionButtons"></ng-container>
</div>

<ng-template #actionButtons>
  <div
    class="text-sm text-gray-400 flex absolute inset-y-0 left-2 items-center"
  >
    <ng-container *ngIf="autosaving; else latestSave">
      <ui-spinner size="small" class="mr-1" />
      {{ 'common.notifications.autoSaving' | translate }}
    </ng-container>
    <ng-template #latestSave>
      <span *ngIf="latestSaveDate"
        >{{
          'components.form.lastSavedAt'
            | translate : { date: latestSaveDate | sharedDate : 'shortTime' }
        }}
      </span>
    </ng-template>
  </div>
  <div
    class="flex justify-end gap-2 flex-wrap"
    [ngClass]="{ 'mt-2 mr-2': !floatingActions }"
  >
    <ui-button
      *ngIf="survey.showToggleExpansion && panels.length"
      (click)="toggleAllPanels()"
      >{{
        collapsed
          ? ('components.form.expandAll' | translate)
          : ('components.form.collapseAll' | translate)
      }}</ui-button
    >
    <ng-container *ngIf="survey?.visiblePages ?? [] as pages">
      <ui-button
        *ngIf="pages.length > 1 && !survey?.hideNavigationButtons"
        [disabled]="survey.isFirstPage"
        variant="primary"
        (click)="survey.prevPage()"
        >{{ 'common.previous' | translate }}</ui-button
      >
      <ui-button
        *ngIf="pages.length > 1 && !survey?.hideNavigationButtons"
        [disabled]="survey.isLastPage"
        variant="primary"
        (click)="survey.nextPage()"
        >{{ 'common.next' | translate }}</ui-button
      >
    </ng-container>
    <!-- <ui-button [disabled]="disableSaveAsDraft" (click)="saveAsDraft()">{{
      'components.form.draftRecords.save' | translate
    }}</ui-button> -->
    <p>
      <ui-button
        variant="primary"
        category="secondary"
        [disabled]="autosaving"
        (click)="submit()"
      >
        <p *ngIf="!autosaving">
          {{ saveButtonText }}
        </p>
        <ui-spinner *ngIf="autosaving" [size]="'small'" />
      </ui-button>
    </p>
  </div>
</ng-template>
