<!-- Content -->
<ui-sidenav-container
  class="sidenav-container"
  [headerTemplate]="headerTemplate"
  [horizontalNavTemplate]="!sideMenu ? leftSidenav : null"
>
  <!-- Left sidenav -->
  <div
    uiSidenavDirective
    #nav="uiSidenavDirective"
    [mode]="largeDevice ? 'side' : 'over'"
    [opened]="largeDevice && sideMenu && menuOpened"
    [visible]="!!leftSidenav"
    class="h-full"
  >
    <ng-container *ngIf="leftSidenav">
      <ng-container
        [ngTemplateOutlet]="leftSidenav"
        [ngTemplateOutletContext]="{ $implicit: nav }"
      ></ng-container>
    </ng-container>
  </div>
  <!-- Right sidenav -->
  <div
    uiSidenavDirective
    class="h-full flex flex-col justify-end"
    position="end"
    [opened]="showSidenav"
    [keepFullscreen]="true"
    #rightNav="uiSidenavDirective"
  >
    <ng-template #rightSidenav></ng-template>
  </div>

  <ng-container ngProjectAs="content">
    <ui-breadcrumbs
      *ngIf="breadcrumbs.length > 1"
      [breadcrumbs]="breadcrumbs"
    ></ui-breadcrumbs>
    <router-outlet></router-outlet>
  </ng-container>
</ui-sidenav-container>

<!-- Header -->
<ng-template #headerTemplate>
  <nav
    id="app-header"
    class="h-[64px] flex px-4 py-3 items-center md:justify-between text-neutral-850 sticky"
    [ngClass]="theme.headerClass"
  >
    <div class="flex items-start content-center">
      <ui-button
        [isIcon]="true"
        [size]="'large'"
        variant="dark"
        category="primary"
        icon="keyboard_backspace"
        (click)="goBack()"
        *ngIf="route"
        [uiTooltip]="'pages.applications.goTo' | translate"
      >
      </ui-button>
      <ng-container *ngIf="header">
        <ng-container *ngTemplateOutlet="header"></ng-container>
      </ng-container>
    </div>
    <!-- Account icon and info -->
    <div class="account-property font-bold text-sm ml-auto mr-1.5">
      {{ account ? account.username : '' }}
    </div>
    <ui-button
      [size]="'large'"
      [isIcon]="true"
      icon="account_circle"
      [uiMenuTriggerFor]="accountMenu"
      variant="dark"
      category="primary"
      [uiTooltip]="'common.account' | translate"
    >
    </ui-button>
    <kendo-badge-container>
      <ui-button
        [size]="'large'"
        variant="dark"
        category="primary"
        [uiMenuTriggerFor]="notificationMenu"
        [disabled]="notifications.length === 0"
        icon="notifications"
        [isIcon]="true"
        [uiTooltip]="'components.notifications.title' | translate"
      >
      </ui-button>
      <kendo-badge
        shape="dot"
        themeColor="error"
        size="small"
        class="!-translate-x-1/4 !translate-y-full"
        *ngIf="notifications.length > 0"
      ></kendo-badge>
    </kendo-badge-container>
    <ui-menu #accountMenu>
      <a uiMenuItem [routerLink]="[profileRoute]">
        {{ 'pages.profile.title' | translate }}
      </a>
      <ng-container *ngIf="showPreferences">
        <ui-divider></ui-divider>
        <button uiMenuItem (click)="onOpenPreferences()">
          {{ 'components.preferences.title' | translate }}
        </button>
      </ng-container>
      <ng-container *ngIf="applications && applications.length > 0">
        <ui-divider></ui-divider>
        <button
          uiMenuItem
          (click)="showAppMenu = !showAppMenu"
          cdkOverlayOrigin
          #appMenuTrigger="cdkOverlayOrigin"
        >
          {{ 'components.header.goToApp' | translate }}
        </button>
        <ng-template
          cdkConnectedOverlay
          [cdkConnectedOverlayOrigin]="appMenuTrigger"
          [cdkConnectedOverlayOpen]="showAppMenu"
        >
          <shared-search-menu
            [applications]="this.applications"
            (close)="showAppMenu = false"
            (open)="onOpenApplication($event)"
          ></shared-search-menu>
        </ng-template>
      </ng-container>
      <ng-container *ngIf="user && user.isAdmin">
        <ui-divider></ui-divider>
        <a uiMenuItem [href]="otherOfficeUri">
          {{ 'components.header.goToPlatform' | translate }} {{ otherOffice }}
        </a>
      </ng-container>
      <ui-divider></ui-divider>
      <button uiMenuItem class="text-red-500" (click)="logout()">
        {{ 'components.header.logout' | translate }}
      </button>
      <div
        class="absolute bottom-0 right-1 text-gray-400 text-xs pointer-events-none"
      >
        {{ environment.version }}
      </div>
    </ui-menu>
    <!-- Notification menu -->
    <ui-menu #notificationMenu [wide]="true">
      <div class="flex flex-col">
        <!-- Header -->
        <div
          class="flex border-b border-light-75 pl-4 pr-2 pt-1 pb-2 items-center gap-2"
        >
          <span class="text-lg font-semibold">{{
            'components.notifications.title' | translate
          }}</span>
          <div
            class="w-7 h-7 rounded-full flex justify-center items-center text-sm text-neutral-850 bg-primary-100 font-semibold"
          >
            {{ notifications.length }}
          </div>
          <ui-button
            variant="dark"
            category="primary"
            (click)="notificationMenu.closed.emit()"
            [isIcon]="true"
            icon="close"
            class="ml-auto"
          >
          </ui-button>
        </div>
        <!-- List of notifications -->
        <div class="flex flex-col overflow-y-auto max-h-[262px]">
          <button
            uiMenuItem
            (click)="onNotificationClick(notification)"
            *ngFor="let notification of notifications"
            class="flex border-b border-light-75 min-h-[88px] py-3"
            [ngClass]="{
              '!border-b-0':
                notification === notifications[notifications.length - 1]
            }"
          >
            <!-- TODO: Figure out what to do with user icon -->
            <ui-icon icon="account_circle" [size]="32" class="mt-1"></ui-icon>
            <div class="h-full flex flex-col justify-between grow text-left">
              <span
                #notificationAction
                class="line-clamp-2 text-sm text-neutral-850"
                [uiTooltip]="
                  notification.action &&
                  notificationAction.scrollHeight >
                    notificationAction.clientHeight
                    ? notification.action
                    : ''
                "
              >
                {{ notification.action }}
              </span>
              <span class="truncate text-xs text-light-200">
                {{ notification.createdAt | sharedDate }}
              </span>
            </div>
            <!-- TODO: Figure out what this red dot indicates -->
            <div class="min-w-2 w-2 h-2 mt-4 rounded-full bg-red-550"></div>
          </button>
        </div>
        <!-- Footer with actions -->
        <div
          class="flex px-3 pt-3 pb-2 justify-between border-t border-light-75"
        >
          <ui-button
            category="primary"
            variant="primary"
            (click)="onMarkAllNotificationsAsRead()"
            icon="done_all"
            iconPosition="suffix"
            shape="round"
            class="[&>button]:!ring-0 [&>button]:!shadow-none [&>*]:!font-medium"
            >{{ 'components.notifications.readAll' | translate }}</ui-button
          >
          <ui-button
            *ngIf="hasMoreNotifications"
            category="secondary"
            variant="primary"
            shape="round"
            [disabled]="loadingNotifications"
            [loading]="loadingNotifications"
            (click)="onLoadMoreNotifications($event)"
            class="[&>*]:!font-semibold"
          >
            {{ 'common.pagination.loadMore' | translate }}
          </ui-button>
        </div>
      </div>
    </ui-menu>
  </nav>
</ng-template>
